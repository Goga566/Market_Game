<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title data-i18n="market_game">Market Game</title>
<style>
  :root{--accent:#3b82f6}
  body{margin:0;font-family:Inter,Arial, Helvetica, sans-serif;background:linear-gradient(180deg,#071020,#021321);color:#e6eef8}
  body.rtl { direction: rtl; }
  .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.88);display:flex;align-items:center;justify-content:center;z-index:60}
  .card{background:linear-gradient(180deg,#071827,#081827);padding:24px;border-radius:12px;width:720px;box-shadow:0 12px 60px rgba(0,0,0,0.7);text-align:center}
  h1{margin:0 0 8px;font-size:26px;color:#dbeafe}
  p.lead{color:#9fb4ff;margin:6px 0 0}
  .btns{margin-top:18px}
  button{background:var(--accent);border:none;color:white;padding:8px 12px;margin:0 6px;border-radius:8px;font-weight:600;cursor:pointer}
  button.secondary{background:#475569}
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.02);position:relative}
  .controls button{margin-left:8px}
  .container{display:flex;gap:12px;padding:12px}
  .left{width:420px;background:rgba(255,255,255,0.02);border-radius:8px;padding:10px}
  .right{flex:1;display:flex;flex-direction:column;gap:12px}
  #canvasWrap{background:#07132a;border-radius:8px;padding:8px}
  canvas{display:block;background:linear-gradient(180deg,#052236,#012030);border-radius:6px}
  table{width:100%;color:#e6eef8;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:14px}
  th{color:#9fb4ff;text-align:left}
  .small{font-size:12px;color:#9fb4ff}
  .chart{height:160px;background:linear-gradient(180deg,#071526,#002233);border-radius:8px;padding:6px}
  .hud{display:flex;gap:12px;align-items:center}
  .hud .box{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px}
  .speedBtns button{margin-right:6px;margin-top:6px;padding:6px 8px;font-size:13px}
  .levelSelect{padding:6px;border-radius:6px}
  .controlsPanel{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .tradePanel{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .tabs{display:flex;gap:6px;margin-bottom:8px}
  .tab{padding:6px 10px;background:rgba(255,255,255,0.02);border-radius:6px;cursor:pointer}
  .tab.active{background:linear-gradient(90deg,#134eec,#3b82f6)}
  .newsTickerWrap{flex:1;margin-left:12px;color:#ffdca3;font-weight:600;overflow:hidden}
  .newsTicker{display:inline-block;white-space:nowrap;padding-left:100%;will-change:transform}
  .profile{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:10px}
  footer{padding:10px;text-align:center;color:#9fb4ff;opacity:0.7}
  input[type=number], input[type=text]{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
  select{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
  .eventsBox{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px}
  .bottomNav{position:fixed;left:12px;right:12px;bottom:12px;display:flex;justify-content:center;gap:12px;z-index:70}
  .bottomNav button{padding:10px 16px;border-radius:10px}
  /* marquee animation */
  @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
  .newsTicker.scrolling { animation: marquee 18s linear infinite; }
  /* modal news list */
  .newsModal{position:fixed;inset:0;background:rgba(2,6,23,0.95);z-index:80;display:flex;align-items:center;justify-content:center}
  .newsModal .panel{width:90%;max-width:900px;background:linear-gradient(180deg,#071827,#081827);border-radius:10px;padding:18px;color:#e6eef8;max-height:80vh;overflow:auto}
  .profileView{position:fixed;inset:8% 10%;background:linear-gradient(180deg,#071827,#081827);border-radius:10px;padding:18px;color:#e6eef8;z-index:75;display:none}
</style>

<!-- I18N Injection START -->
<script>
// Simple client-side i18n (languages and translations)
const I18N_LANGS = {
  'ru': { 'market_game':'Market Game', 'news':'–ù–æ–≤–æ—Å—Ç–∏', 'profile':'–ü—Ä–æ—Ñ–∏–ª—å', 'game':'–ò–≥—Ä–∞', 'messages':'–°–æ–æ–±—â–µ–Ω–∏—è', 'subscribe':'–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è', 'unsubscribe':'–û—Ç–ø–∏—Å–∞—Ç—å—Å—è', 'add_friend':'–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è', 'remove_friend':'–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π', 'write_msg':'–ù–∞–ø–∏—Å–∞—Ç—å', 'block':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', 'report':'–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è', 'new':'–ù–æ–≤—ã–π', 'send':'–û—Ç–ø—Ä–∞–≤–∏—Ç—å', 'attach':'–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å', 'search_players':'–ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤', 'friends':'–î—Ä—É–∑—å—è', 'followers':'–ü–æ–¥–ø–∏—Å—á–∏–∫–∏','following':'–ü–æ–¥–ø–∏—Å–∫–∏', 'global':'–ì–ª–æ–±–∞–ª—å–Ω—ã–π', 'difficulty':'–°–ª–æ–∂–Ω–æ—Å—Ç—å', 'easy':'–õ—ë–≥–∫–∏–π', 'normal':'–ù–æ—Ä–º–∞–ª—å–Ω—ã–π', 'hard':'–°–ª–æ–∂–Ω—ã–π', 'very_hard':'–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π', 'admin':'–ê–¥–º–∏–Ω', 'admin_login':'–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω', 'enter_email':'Email', 'enter_password':'–ü–∞—Ä–æ–ª—å', 'ok':'OK', 'cancel':'–û—Ç–º–µ–Ω–∞', 'register':'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', 'login':'–í–æ–π—Ç–∏', 'logout':'–í—ã–π—Ç–∏', 'search':'–ü–æ–∏—Å–∫', 'tax':'–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞', 'add_security':'–î–æ–±–∞–≤–∏—Ç—å –±—É–º–∞–≥—É', 'remove_security':'–£–¥–∞–ª–∏—Ç—å –±—É–º–∞–≥—É', 'block_player':'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞', 'unblock_player':'–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∏–≥—Ä–æ–∫–∞', 'choose_language':'–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫', 'level':'–£—Ä–æ–≤–µ–Ω—å', 'nickname':'–ù–∏–∫', 'currency':'–í–∞–ª—é—Ç–∞', 'balance':'–ë–∞–ª–∞–Ω—Å', 'start':'–°—Ç–∞—Ä—Ç', 'save':'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', 'load':'–ó–∞–≥—Ä—É–∑–∏—Ç—å', 'exit':'–í—ã—Ö–æ–¥', 'assets':'–ê–∫—Ç–∏–≤—ã', 'code':'–ö–æ–¥', 'name':'–ò–º—è', 'price':'–¶–µ–Ω–∞', 'volatility':'–í–æ–ª–∞—Ç', 'holdings':'–í –¥–µ—Ä–∂.', 'all':'–í—Å–µ', 'stock':'–ê–∫—Ü–∏–∏', 'currency_tab':'–í–∞–ª—é—Ç–∞', 'crypto':'–ö—Ä–∏–ø—Ç–æ', 'bond':'–û–±–ª–∏–≥–∞—Ü–∏–∏', 'game_speed':'–°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã', 'set_level':'–£—Ä–æ–≤–µ–Ω—å (—Å–º–µ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)', 'apply':'–ü—Ä–∏–º–µ–Ω–∏—Ç—å', 'transactions':'–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', 'portfolio':'–ü–æ—Ä—Ç—Ñ–µ–ª—å', 'market_events':'–°–æ–±—ã—Ç–∏—è —Ä—ã–Ω–∫–∞', 'buy':'–ö—É–ø–∏—Ç—å', 'sell':'–ü—Ä–æ–¥–∞—Ç—å', 'available':'–î–æ—Å—Ç—É–ø–Ω–æ', 'portfolio_value':'–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ', 'market_estate':'–†—ã–Ω–æ–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏', 'close':'–ó–∞–∫—Ä—ã—Ç—å', 'everything':'–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã', 'real_estate':'–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', 'tax_rate':'–ù–∞–ª–æ–≥–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞', 'owner':'–í–ª–∞–¥–µ–ª–µ—Ü', 'sell_property':'–ü—Ä–æ–¥–∞—Ç—å', 'add_property':'–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç' },
  'en': { 'market_game':'Market Game', 'news':'News', 'profile':'Profile', 'game':'Game', 'messages':'Messages', 'subscribe':'Subscribe', 'unsubscribe':'Unsubscribe', 'add_friend':'Add Friend', 'remove_friend':'Remove Friend', 'write_msg':'Message', 'block':'Block', 'report':'Report', 'new':'New', 'send':'Send', 'attach':'Attach', 'search_players':'Search players', 'friends':'Friends', 'followers':'Followers','following':'Following', 'global':'Global', 'difficulty':'Difficulty', 'easy':'Easy', 'normal':'Normal', 'hard':'Hard', 'very_hard':'Very hard', 'admin':'Admin', 'admin_login':'Admin login', 'enter_email':'Email', 'enter_password':'Password', 'ok':'OK', 'cancel':'Cancel', 'register':'Register', 'login':'Login', 'logout':'Logout', 'search':'Search', 'tax':'Tax rate', 'add_security':'Add security', 'remove_security':'Remove security', 'block_player':'Block player', 'unblock_player':'Unblock player', 'choose_language':'Choose language', 'level':'Level', 'nickname':'Nickname', 'currency':'Currency', 'balance':'Balance', 'start':'Start', 'save':'Save', 'load':'Load', 'exit':'Exit', 'assets':'Assets', 'code':'Code', 'name':'Name', 'price':'Price', 'volatility':'Volatility', 'holdings':'Holdings', 'all':'All', 'stock':'Stocks', 'currency_tab':'Currency', 'crypto':'Crypto', 'bond':'Bonds', 'game_speed':'Game Speed', 'set_level':'Level (change in process)', 'apply':'Apply', 'transactions':'Last Transactions', 'portfolio':'Portfolio', 'market_events':'Market Events', 'buy':'Buy', 'sell':'Sell', 'available':'Available', 'portfolio_value':'Portfolio Value', 'market_estate':'Real Estate Market', 'close':'Close', 'everything':'Everything', 'real_estate':'Real Estate', 'tax_rate':'Tax rate', 'owner':'Owner', 'sell_property':'Sell', 'add_property':'Add property' }
  // additional langs omitted here for brevity ‚Äî keep original I18N_LANGS in your real file
};
let CURRENT_LANG = localStorage.getItem('lang') || 'ru';
function t(key){ const d = I18N_LANGS[CURRENT_LANG] || I18N_LANGS['ru']; return (d && d[key])||key; }
function setLang(l){ CURRENT_LANG = l; localStorage.setItem('lang', l); document.documentElement.lang = l; if(['ar','he'].includes(l)){ document.documentElement.dir='rtl'; document.body.classList.add('rtl'); } else { document.documentElement.dir='ltr'; document.body.classList.remove('rtl'); } applyTranslations(); updateUiLangIndicators(); }
function applyTranslations(){
  // translate elements with data-i18n attribute
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k = el.getAttribute('data-i18n'); const val = t(k); if(val && el.tagName.toLowerCase()==='input'){ el.placeholder = val; } else { el.innerText = val; } });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k = el.getAttribute('data-i18n-placeholder'); el.placeholder = t(k); });
  // dynamic text nodes
  const map = { 'mainStart':'start', 'mainPause':'pause', 'btnBuy':'buy', 'btnSell':'sell', 'openProfileBtn':'profile', 'openGameBtn':'game' };
  for(const id in map){ const el = document.getElementById(id); if(el) el.innerText = t(map[id]); }
  // tabs
  document.querySelectorAll('.tab').forEach(tn=>{ if(tn.dataset.filter==='bond') tn.innerText = t('bond'); if(tn.dataset.filter==='currency') tn.innerText = t('currency_tab'); if(tn.dataset.filter==='stock') tn.innerText = t('stock'); if(tn.dataset.filter==='crypto') tn.innerText = t('crypto'); if(tn.dataset.filter==='all') tn.innerText = t('all'); });
}
function updateUiLangIndicators(){ const s = document.getElementById('currentLang'); if(s) s.innerText = (CURRENT_LANG||'ru').toUpperCase(); const sel = document.getElementById('startLang'); if(sel) sel.value = CURRENT_LANG; const mainSel = document.getElementById('langSelect'); if(mainSel) mainSel.value = CURRENT_LANG; }
window.setLang = setLang; window.t = t; window.applyTranslations = applyTranslations; window.I18N_LANGS = I18N_LANGS;
</script>
<!-- I18N Injection END -->
</head>
<body>

<!-- Start overlay where player chooses level, nick and optionally starting balance -->
<div id="startOverlay" class="overlay">
  <div class="card">
    <h1 data-i18n="market_game">Market Game</h1>
    <p class="lead" data-i18n="choose_language">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫, —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏, –Ω–∏–∫ –∏ –≤–∞–ª—é—Ç—É. –ù–∞ –Ω–æ–≤–∏—á–∫–µ –≤—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å.</p>
    <div style="margin-top:12px;display:flex;justify-content:center;gap:8px;align-items:center;flex-wrap:wrap">
      <label style="color:#9fb4ff" data-i18n="choose_language">–Ø–∑—ã–∫:</label>
      <select id="startLang" class="levelSelect">
        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
        <option value="en">üá¨üáß English</option>
        <option value="de">üá©üá™ Deutsch</option>
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
        <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="he">üáÆüá± ◊¢◊ë◊®◊ô◊™</option>
        <option value="zh-CN">üá®üá≥ ÁÆÄ‰Ωì</option>
        <option value="zh-TW">üáπüáº ÁπÅÈ´î</option>
        <option value="sa">üïâÔ∏è SA</option>
      </select>

      <label style="color:#9fb4ff">–£—Ä–æ–≤–µ–Ω—å:</label>
      <select id="startLevel" class="levelSelect" data-i18n-select>
        <option value="0" data-i18n="easy">–õ—ë–≥–∫–∏–π (–≤—ã –≤—ã–±–∏—Ä–∞–µ—Ç–µ –±–∞–ª–∞–Ω—Å)</option>
        <option value="1" selected data-i18n="normal">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π (–±–∞–ª–∞–Ω—Å $3000)</option>
        <option value="2">–°–ª–æ–∂–Ω—ã–π (–±–∞–ª–∞–Ω—Å $1000)</option>
        <option value="3">–ö–æ—à–º–∞—Ä (–±–∞–ª–∞–Ω—Å $500)</option>
      </select>
      <label style="color:#9fb4ff;margin-left:6px" data-i18n="nickname">–ù–∏–∫:</label>
      <input id="startNick" placeholder="–ò–≥—Ä–æ–∫" style="width:140px" />
      <label style="color:#9fb4ff;margin-left:6px" data-i18n="currency">–í–∞–ª—é—Ç–∞:</label>
      <select id="startCurrency">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="RUB">RUB</option>
        <option value="JPY">JPY</option>
        <option value="GBP">GBP</option>
      </select>
      <label id="startBalanceLabel" style="color:#9fb4ff;margin-left:6px;display:none" data-i18n="balance">–ë–∞–ª–∞–Ω—Å:</label>
      <input id="startBalance" type="number" value="5000" style="width:120px;display:none" />
    </div>
    <div class="btns">
      <button id="btnStart" data-i18n="start">–°—Ç–∞—Ä—Ç</button>
      <button id="btnSave" class="secondary" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="btnLoad" class="secondary" data-i18n="load">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button id="btnExit" class="secondary" data-i18n="exit">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
</div>

<div class="topbar">
  <div style="display:flex;align-items:center;gap:12px">
    <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%233b82f6'/><text x='50%' y='58%' font-size='18' font-family='Arial' fill='white' text-anchor='middle'>MG</text></svg>" style="height:36px;border-radius:6px"/>
    <div>
      <div style="font-weight:700"><span data-i18n="market_game">Market Game</span></div>
      <!-- Admin login UI (kept on left) -->
<button id="adminOpenBtn" title="Admin" style="position:fixed;left:16px;top:12px;z-index:90;background:transparent;border:none;cursor:pointer">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v6" stroke="#ffd700" stroke-width="1.5" stroke-linecap="round"/><path d="M4 8v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8" stroke="#ffd700" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
</button>
<div id="adminModal" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(180deg,#071827,#081827);padding:18px;border-radius:10px;z-index:200;width:320px;box-shadow:0 12px 60px rgba(0,0,0,0.7)">
  <div style="font-weight:700;margin-bottom:8px"><span data-i18n="admin_login">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</span></div>
  <div style="margin-bottom:8px"><label><span data-i18n="enter_email">Email</span></label><input id="adminEmail" style="width:100%;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"/></div>
  <div style="margin-bottom:8px"><label><span data-i18n="enter_password">–ü–∞—Ä–æ–ª—å</span></label><input id="adminPass" type="password" style="width:100%;padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"/></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="adminCancel" data-i18n="cancel">–û—Ç–º–µ–Ω–∞</button>
    <button id="adminLoginBtn" data-i18n="ok">OK</button>
  </div>
  <div id="adminPanel" style="margin-top:12px;display:none">
    <div style="font-weight:700">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="adminAction">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É</button>
      <button class="adminAction">–ü–∞—É–∑–∞</button>
      <button class="adminAction">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="adminAction">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      <button class="adminAction">–°–±—Ä–æ—Å</button>
      <button id="changeAdminPass">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>
    <div id="adminInfo" style="margin-top:8px;font-size:13px;color:#9fb4ff"></div>
  </div>
</div>
<script>
(function(){
  const adminOpen = document.getElementById('adminOpenBtn');
  const adminModal = document.getElementById('adminModal');
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminCancel = document.getElementById('adminCancel');
  const adminPanel = document.getElementById('adminPanel');
  const adminInfo = document.getElementById('adminInfo');
  const changePassBtn = document.getElementById('changeAdminPass');
  const ADMIN_STORAGE_KEY = 'admin_credentials_v1';
  // default credentials
  const defaultCreds = {email:'tortovanilla@gmail.com', pass:'wert543gfuoo'};
  // load stored or default
  let creds = JSON.parse(localStorage.getItem(ADMIN_STORAGE_KEY) || JSON.stringify(defaultCreds));

  adminOpen.addEventListener('click', ()=>{ adminModal.style.display='block'; });
  adminCancel.addEventListener('click', ()=>{ adminModal.style.display='none'; });
  adminLoginBtn.addEventListener('click', ()=>{
    const e = document.getElementById('adminEmail').value; const p = document.getElementById('adminPass').value;
    if(e===creds.email && p===creds.pass){ adminPanel.style.display='block'; adminInfo.innerText = '–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω'; // show admin UI
      // allow admin actions
    } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'); }
  });
  changePassBtn && changePassBtn.addEventListener('click', ()=>{
    const np = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:'); if(np){ creds.pass = np; localStorage.setItem(ADMIN_STORAGE_KEY, JSON.stringify(creds)); alert('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω'); }
  });
})();
</script>

      <div class="small">–°–∏–º—É–ª—è—Ü–∏—è —Ä—ã–Ω–∫–∞ —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–º</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px;flex:1">
    <div class="newsTickerWrap" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π">
      <div id="newsTicker" class="newsTicker"><span data-i18n="news">–ù–æ–≤–æ—Å—Ç–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å...</span></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <label class="small">–í–∞–ª—é—Ç–∞</label>
      <select id="mainCurrency">
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="RUB">RUB</option>
        <option value="JPY">JPY</option>
        <option value="GBP">GBP</option>
      </select>
      <!-- LANGUAGE BUTTON MOVED TO RIGHT SIDE (visually separated from admin) -->
      <button id="langBtn" title="Language" style="margin-left:12px;background:transparent;border:none;color:inherit;cursor:pointer">üåê <span id="currentLang">RU</span></button>
    </div>
    <div class="hud">
      <div class="box">–ë–∞–ª–∞–Ω—Å: <strong id="balanceDisplay">0</strong></div>
      <div class="box">–ß–∏—Å—Ç–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <strong id="netWorthDisplay">0</strong></div>
      <div class="box">–£—Ä–æ–≤–µ–Ω—å: <strong id="levelLabel">–°—Ç–∞–Ω–¥–∞—Ä—Ç</strong></div>
      <div class="box">–°–∫–æ—Ä–æ—Å—Ç—å: <strong id="speedLabel">1x</strong></div>
    </div>
    <div class="controls">
      <button id="mainStart" data-i18n="start">–°—Ç–∞—Ä—Ç</button>
      <button id="mainPause" class="secondary" data-i18n="start">–ü–∞—É–∑–∞</button>
      <button id="mainSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="mainExit" class="secondary">–í—ã—Ö–æ–¥</button>
    </div>
  </div>
</div>

<!-- language modal (position adjusted to right) -->
<div id="langModal" style="display:none;position:absolute;right:16px;top:56px;z-index:95;background:linear-gradient(180deg,#071827,#081827);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);min-width:280px">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <strong data-i18n="choose_language">–Ø–∑—ã–∫ / Language</strong>
    <button id="langClose" style="background:transparent;border:none;color:#9fb4ff;cursor:pointer">‚úï</button>
  </div>
  <div style="margin-top:8px">
    <div style="overflow-x:auto;white-space:nowrap;padding-bottom:6px" id="langScroll">
      <button class="langItem" data-lang="ru">üá∑üá∫ RU</button>
      <button class="langItem" data-lang="en">üá¨üáß EN</button>
      <button class="langItem" data-lang="de">üá©üá™ DE</button>
      <button class="langItem" data-lang="fr">üá´üá∑ FR</button>
      <button class="langItem" data-lang="uk">üá∫üá¶ UK</button>
      <button class="langItem" data-lang="ar">üá∏üá¶ AR</button>
      <button class="langItem" data-lang="he">üáÆüá± HE</button>
      <button class="langItem" data-lang="zh-CN">üá®üá≥ ÁÆÄ</button>
      <button class="langItem" data-lang="zh-TW">üáπüáº ÁπÅ</button>
      <button class="langItem" data-lang="sa">üïâÔ∏è SA</button>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
      <input type="range" id="langRange" min=0 max=100 value=0 style="flex:1">
      <small class="small" style="width:80px;text-align:right">Scroll</small>
    </div>
  </div>
</div>

<div id="gameArea" class="container">
  <div class="left">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 data-i18n="assets">–ê–∫—Ç–∏–≤—ã</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tabs" id="tabs">
          <div class="tab active" data-filter="all" data-i18n="all">–í—Å–µ</div>
          <div class="tab" data-filter="stock" data-i18n="stock">–ê–∫—Ü–∏–∏</div>
          <div class="tab" data-filter="currency_tab" data-i18n="currency_tab">–í–∞–ª—é—Ç–∞</div>
          <div class="tab" data-filter="crypto" data-i18n="crypto">–ö—Ä–∏–ø—Ç–æ</div>
          <div class="tab" data-filter="bond" data-i18n="bond">–û–±–ª–∏–≥–∞—Ü–∏–∏</div>
        </div>
      </div>
    </div>
    <table id="assetsTable"><thead><tr><th data-i18n="code">–ö–æ–¥</th><th data-i18n="name">–ò–º—è</th><th data-i18n="price">–¶–µ–Ω–∞</th><th data-i18n="volatility">–í–æ–ª–∞—Ç</th><th data-i18n="holdings">–í –¥–µ—Ä–∂.</th></tr></thead><tbody></tbody></table>
    <div style="height:8px"></div>
    <div class="small">–ö–ª–∏–∫ –Ω–∞ —Å—Ç—Ä–æ–∫–µ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏ –ø–∞–Ω–µ–ª—å —Ç–æ—Ä–≥–æ–≤–ª–∏.</div>

    <div style="margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px" data-i18n="game_speed">–°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã</div>
      <div class="speedBtns" id="speedBtns"></div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:600;margin-bottom:6px">–£—Ä–æ–≤–µ–Ω—å (—Å–º–µ–Ω–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)</div>
      <select id="levelSelect" class="levelSelect" data-i18n-select>
        <option value="0" data-i18n="easy">–õ—ë–≥–∫–∏–π</option>
        <option value="1" selected data-i18n="normal">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
        <option value="2" data-i18n="hard">–°–ª–æ–∂–Ω—ã–π</option>
        <option value="3">–ö–æ—à–º–∞—Ä</option>
      </select>
      <button id="applyLevel" class="secondary" style="margin-left:8px" data-i18n="apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>

    <div class="profile" id="profileBox">
      <div style="font-weight:700" data-i18n="profile">–ü—Ä–æ—Ñ–∏–ª—å (–º–∏–Ω–∏)</div>
      <div style="margin-top:6px">–ù–∏–∫: <input id="nick" placeholder="–ò–≥—Ä–æ–∫" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.05);color:#e6eef8" /></div>
      <div style="margin-top:6px" data-i18n="transactions">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</div>
      <div id="txList" style="max-height:120px;overflow:auto;font-size:13px;color:#d1e9ff"></div>
      <div style="margin-top:6px" data-i18n="portfolio">–ü–æ—Ä—Ç—Ñ–µ–ª—å:</div>
      <div id="holdingsList" style="max-height:120px;overflow:auto;font-size:13px;color:#d1e9ff"></div>
    </div>

  </div>
  <div class="right">
    <div id="canvasWrap">
      <canvas id="gameCanvas" width="640" height="240"></canvas>
    </div>
    <div class="chart" id="chartArea">
      <canvas id="chartCanvas" width="640" height="160"></canvas>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <div class="tradePanel" id="tradePanel">
          <div style="font-weight:700">–í—ã–±—Ä–∞–Ω–æ: <span id="selLabel">‚Äî</span></div>
          <div style="margin-top:6px">–ö–æ–ª-–≤–æ: <input type="number" id="tradeQty" value="1" min="0" step="1" style="width:90px" /></div>
          <div style="margin-top:6px;display:flex;gap:8px">
            <button id="btnBuy" data-i18n="buy">–ö—É–ø–∏—Ç—å</button>
            <button id="btnSell" class="secondary" data-i18n="sell">–ü—Ä–æ–¥–∞—Ç—å</button>
          </div>
          <div style="margin-top:8px" class="small">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="holdings">0</span> | –°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø–æ—Ä—Ç—Ñ–µ–ª–µ: <span id="holdingValue">0</span></div>
        </div>
        <div style="text-align:right">
          <div class="small">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</div>
          <div style="font-weight:700" id="instInfo">‚Äî</div>
          <div class="small" style="margin-top:6px">–¶–µ–Ω–∞: <span id="instPrice">‚Äî</span></div>
        </div>
      </div>
    </div>
    <div class="eventsBox">
      <div style="font-weight:700" data-i18n="market_events">–°–æ–±—ã—Ç–∏—è —Ä—ã–Ω–∫–∞</div>
      <div id="eventsList" class="small" style="margin-top:6px;max-height:120px;overflow:auto"></div>
    </div>
  </div>
</div>

<footer style="position:fixed;left:0;right:0;bottom:0;text-align:center;background:transparent;padding-bottom:54px" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (JSON). –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª.</footer>

<!-- hidden file input -->
<input id="fileIn" type="file" accept="application/json" style="display:none" />

<!-- news modal -->
<div id="newsModal" class="newsModal" style="display:none">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:18px;font-weight:700" data-i18n="news">–í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏</div>
      <div><button id="closeNews" data-i18n="close">–°–≤–µ—Ä–Ω—É—Ç—å</button></div>
    </div>
    <div id="newsList" style="margin-top:12px;max-height:60vh;overflow:auto"></div>
  </div>
</div>

<!-- full profile view -->
<div id="profileView" class="profileView">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:20px;font-weight:700" data-i18n="profile">–ü—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞</div>
    <div><button id="closeProfile" data-i18n="close">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  </div>
  <div style="display:flex;gap:18px">
    <div style="flex:1">
      <div style="font-weight:700">–ê–∫–∫–∞—É–Ω—Ç</div>
      <div style="margin-top:8px">–ù–∏–∫: <input id="profileNick" style="width:200px"/></div>
      <div style="margin-top:8px">–ë–∞–ª–∞–Ω—Å: <strong id="profileBalance">0</strong></div>
      <div style="margin-top:8px">–û—Å–Ω–æ–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞: <strong id="profileCurrency">USD</strong></div>
      <div style="margin-top:12px">–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:</div>
      <div id="profileTxs" style="max-height:40vh;overflow:auto;margin-top:6px"></div>
    </div>
    <div style="width:380px">
      <div style="font-weight:700">–ü–æ—Ä—Ç—Ñ–µ–ª—å</div>
      <div id="profileHoldings" style="max-height:60vh;overflow:auto;margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- bottom nav -->
<div class="bottomNav">
  <button id="openProfileBtn" class="secondary"><span data-i18n="profile">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
  <button id="openGameBtn"><span data-i18n="game">–ò–≥—Ä–∞</span></button>
</div>

<script>
// --- –ò–≥—Ä–∞: –±–∞–ª–∞–Ω—Å, —É—Ä–æ–≤–Ω–∏, —Å–∫–æ—Ä–æ—Å—Ç—å, –Ω–æ–≤–æ—Å—Ç–∏ –∏ —Å–æ–±—ã—Ç–∏—è ---
let running = false;
const baseInterval = 1000; // ms per tick at 1x
let speed = 1.0; // multiplier (0.1 ... 10)
let tickTimer = null;
let assets = [];
let historyLen = 240;
let selected = null;
let balance = 0.0; // starting will be set at start
let level = 1; // 0..3
let volatilityFactors = [0.5, 1.0, 1.8, 3.5]; // multiplier per level
let globalVolFactor = volatilityFactors[level];
let newsHistory = []; // all news ever
let activeEvents = [];
let transactions = [];
let nickname = '–ò–≥—Ä–æ–∫';
let mainCurrency = 'USD';

const exchangeRates = { USD:1.0, EUR:0.92, RUB:95.0, JPY:150.0, GBP:0.78 };

const speedOptions = [0.1,0.25,0.5,0.75,1,2,3,4,5,10];
let currentFilter = 'all';

// Initialize assets: store prices in USD internally
function initAssets(){
  assets = [];
  const stocks = [ ['AAPL','Apple Inc.'], ['MSFT','Microsoft'], ['GOOGL','Alphabet'], ['AMZN','Amazon'], ['TSLA','Tesla'], ['NVDA','Nvidia'], ['BABA','Alibaba'], ['ORCL','Oracle'] ];
  const cryptos = [ ['BTC','Bitcoin'], ['ETH','Ethereum'], ['BNB','Binance Coin'], ['SOL','Solana'], ['ADA','Cardano'] ];
  const currencies = [ ['USD','US Dollar'], ['EUR','Euro'], ['RUB','Ruble'], ['JPY','Yen'], ['GBP','Pound'] ];
  const bonds = [ ['BND-A','–û–±–ª–∏–≥–∞—Ü–∏—è A',0.04,365], ['BND-B','–û–±–ª–∏–≥–∞—Ü–∏—è B',0.06,730], ['BND-C','–û–±–ª–∏–≥–∞—Ü–∏—è C',0.08,1095] ]; // [key,name,coupon,daysToMaturity]
  stocks.forEach(s=> assets.push({key:s[0],name:s[1],baseUSD:rand(20,800),price:0,history:[],cat:'stock',shares:0}));
  cryptos.forEach(c=> assets.push({key:c[0],name:c[1],baseUSD:rand(100,40000),price:0,history:[],cat:'crypto',shares:0}));
  currencies.forEach(c=> assets.push({key:c[0],name:c[1],baseUSD:rand(0.5,120),price:0,history:[],cat:'currency',shares:0}));
  bonds.forEach(b=> assets.push({key:b[0],name:b[1],baseUSD:100,price:0,history:[],cat:'bond',shares:0,coupon:b[2],maturityDays:b[3],issuedAt:Date.now()}));
  // set initial price in chosen main currency
  assets.forEach(a=>{ a.price = a.baseUSD * exchangeRates[mainCurrency]; a.history.push(a.price); });
}


function applyLevel(l){ level = Number(l); globalVolFactor = volatilityFactors[level]; document.getElementById('levelLabel').innerText = ['–õ—ë–≥–∫–∏–π','–ù–æ—Ä–º–∞–ª—å–Ω—ã–π','–°–ª–æ–∂–Ω—ã–π','–ö–æ—à–º–∞—Ä'][level]; }

function rand(min,max){return Math.random()*(max-min)+min}

function computeVol(a){
  if(a.history.length<2) return 0
  let rets = []
  for(let i=1;i<a.history.length;i++){ let p0=a.history[i-1], p1=a.history[i]; if(p0==0) continue; rets.push((p1-p0)/p0) }
  if(rets.length==0) return 0
  let mean = rets.reduce((s,x)=>s+x,0)/rets.length
  let varr = rets.reduce((s,x)=>s+(x-mean)*(x-mean),0)/rets.length
  let st = Math.sqrt(varr)
  let vol = st*Math.sqrt(60)*100
  return vol
}

// Events and news
const newsTemplates = [
  {text:'–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Ö—É–∂–µ –æ–∂–∏–¥–∞–Ω–∏–π: —Ä—ã–Ω–æ–∫ –≤–æ–ª–∞—Ç–∏–ª–µ–Ω',impact:-0.03,duration:6},
  {text:'–•–æ—Ä–æ—à–∏–µ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –∫—Ä—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π',impact:0.04,duration:5},
  {text:'–†–µ–≥—É–ª—è—Ç–æ—Ä —É—Å–∏–ª–∏–ª –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º–∏',impact:-0.06,duration:8,filter:'crypto'},
  {text:'–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –≤–æ–∑—Ä–æ—Å–ª–∏',impact:-0.05,duration:7},
  {text:'–ù–æ–≤–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ—Ä—ã–≤–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞',impact:0.06,duration:6,filter:'stock'},
  {text:'–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫ –ø–æ–Ω–∏–∑–∏–ª —Å—Ç–∞–≤–∫—É',impact:0.03,duration:6,filter:'currency'}
]

function pushNews(item){
  const id = Date.now() + Math.floor(Math.random()*999)
  const ev = {id, text: item.text, impact: item.impact, duration: item.duration, remaining: item.duration, filter: item.filter || 'all', time: Date.now()}
  activeEvents.push(ev)
  newsHistory.unshift(ev) // keep all news
  if(newsHistory.length>500) newsHistory.pop()
  renderNewsTicker()
  renderEventsList()
}

function renderNewsTicker(){
  const el = document.getElementById('newsTicker')
  if(newsHistory.length==0) { el.innerText = t('news') + ' –±—É–¥—É—Ç –∑–¥–µ—Å—å...'; el.classList.remove('scrolling'); return }
  el.innerText = newsHistory.length>0 ? newsHistory[0].text : t('news') + ' –±—É–¥—É—Ç –∑–¥–µ—Å—å...'
  // start scrolling class
  el.classList.add('scrolling')
}

function renderNewsModal(){
  const el = document.getElementById('newsList'); el.innerHTML=''
  newsHistory.forEach(n=>{ const d=document.createElement('div'); d.style.padding='8px 0'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)'; d.innerText = new Date(n.time).toLocaleString()+': '+n.text; el.appendChild(d) })
}

function renderEventsList(){
  const out = document.getElementById('eventsList')
  out.innerHTML = ''
  activeEvents.forEach(e=>{
    const d = document.createElement('div'); d.innerText = `${e.text} (–æ—Å—Ç–∞–ª–æ—Å—å ${e.remaining} —Ç–∏–∫–æ–≤)`; out.appendChild(d)
  })
}

function stepEvents(){
  for(let i=activeEvents.length-1;i>=0;i--){ activeEvents[i].remaining -= 1; if(activeEvents[i].remaining <=0) activeEvents.splice(i,1) }
  renderNewsTicker(); renderEventsList();
}

function maybeSpawnNews(){
  if(Math.random() < 0.25){ const tmpl = newsTemplates[Math.floor(Math.random()*newsTemplates.length)]; pushNews(tmpl) }
}

function applyEventImpactToAsset(a){
  let totalImpact = 0
  activeEvents.forEach(ev=>{ if(ev.filter==='all' || ev.filter === a.cat) totalImpact += ev.impact })
  return totalImpact
}

function updatePrices(){
  assets.forEach(a=>{
    let baseRange = 0.01
    if(a.cat=='stock') baseRange = 0.02
    else if(a.cat=='currency') baseRange = 0.003
    else if(a.cat=='crypto') baseRange = 0.06
    const v = rand(-baseRange*globalVolFactor, baseRange*globalVolFactor)
    const evImp = applyEventImpactToAsset(a)
    let shock = 0
    if(Math.random()<0.01) shock = rand(-0.15,0.15)
    // modify baseUSD slightly to simulate long-term changes, but keep price = baseUSD * rate
    a.baseUSD = Math.max(0.0000001, a.baseUSD * (1+v+evImp+shock))
    a.price = a.baseUSD * exchangeRates[mainCurrency]
    a.history.push(a.price)
    if(a.history.length>historyLen) a.history.shift()
  })
  stepEvents()
  if(Math.random() < 0.3) maybeSpawnNews()

  refreshTable(); drawScene(); drawChart(); updateHUD(); renderProfile();
}

function refreshTable(){
  const tbody = document.querySelector('#assetsTable tbody')
  tbody.innerHTML=''
  assets.filter(a=> currentFilter==='all' ? true : a.cat===currentFilter).forEach(a=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${a.key}</td><td>${a.name}</td><td>${a.price.toFixed(4)} ${mainCurrency}</td><td>${computeVol(a).toFixed(2)}%</td><td>${(a.shares||0).toFixed(2)}</td>`
    tr.style.cursor='pointer'
    tr.onclick = ()=>{ selected = a; drawChart(); highlightSelectedRow(tr); showTradePanel(a) }
    tbody.appendChild(tr)
  })
}

function highlightSelectedRow(row){
  document.querySelectorAll('#assetsTable tbody tr').forEach(r=>r.style.background='')
  row.style.background='rgba(255,255,255,0.03)'
}

// canvas scene
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let particles=[]
function spawnParticles(){
  particles = []
  assets.forEach((a,i)=>{
    let x = 40 + (i%8)*70 + rand(-10,10)
    let y = 40 + Math.floor(i/8)*70 + rand(-8,8)
    particles.push({x,y,dx:rand(-0.6,0.6),dy:rand(-0.4,0.4),size:6+Math.log(a.price+1)})
  })
}
function drawScene(){
  ctx.clearRect(0,0,canvas.width,canvas.height)
  let g = ctx.createLinearGradient(0,0,0,canvas.height)
  g.addColorStop(0,'#002c4a'); g.addColorStop(1,'#00141f')
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height)
  particles.forEach((p,i)=>{
    const a = assets[i]
    p.x += p.dx * (0.5 + computeVol(a)/10)
    p.y += p.dy * (0.5 + computeVol(a)/10)
    if(p.x<20 || p.x>canvas.width-20) p.dx *= -1
    if(p.y<20 || p.y>canvas.height-20) p.dy *= -1
    let s = 6 + Math.min(36, Math.log(a.price+1))
    let color = '#68d391'
    if(a.cat=='crypto') color = '#f6c177'
    if(a.cat=='currency') color = '#90cdf4'
    ctx.beginPath(); ctx.fillStyle=color; ctx.globalAlpha=0.14; ctx.arc(p.x,p.y,s*2.2,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1
    ctx.beginPath(); ctx.fillStyle=color; ctx.arc(p.x,p.y,s,0,Math.PI*2); ctx.fill()
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.font='12px Arial'; ctx.fillText(a.key, p.x-8, p.y+4)
  })
  ctx.fillStyle='rgba(255,255,255,0.04)'
  ctx.fillRect(8,8,300,36)
  ctx.fillStyle='#cfe8ff'; ctx.font='13px Arial'
  ctx.fillText('Assets: '+assets.length+' | Events: '+activeEvents.length, 16, 30)
}

// chart drawing
const chart = document.getElementById('chartCanvas');
const cctx = chart.getContext('2d');
function drawChart(){
  cctx.clearRect(0,0,chart.width,chart.height)
  cctx.fillStyle='#001a26'; cctx.fillRect(0,0,chart.width,chart.height)
  if(!selected) return
  const arr = selected.history.slice(-Math.min(selected.history.length, Math.floor(chart.width/2)))
  if(arr.length<2) return
  const min = Math.min(...arr), max=Math.max(...arr)
  const range = Math.max(1e-9, max-min)
  cctx.beginPath();
  arr.forEach((v,i)=>{
    const x = i*(chart.width/arr.length)
    const y = chart.height - ((v-min)/range)*chart.height
    if(i==0) cctx.moveTo(x,y); else cctx.lineTo(x,y)
  })
  cctx.strokeStyle='#7dd3fc'; cctx.lineWidth=2; cctx.stroke()
  cctx.fillStyle='rgba(125,211,252,0.06)'
  cctx.globalCompositeOperation='destination-over'
  cctx.beginPath(); arr.forEach((v,i)=>{ const x=i*(chart.width/arr.length); const y=chart.height - ((v-min)/range)*chart.height; if(i==0) cctx.moveTo(x,y); else cctx.lineTo(x,y)}); cctx.lineTo(chart.width,chart.height); cctx.lineTo(0,chart.height); cctx.closePath(); cctx.fill(); cctx.globalCompositeOperation='source-over'
  cctx.fillStyle='#bfeaff'; cctx.font='13px Arial'; cctx.fillText(selected.key+' ‚Äî '+selected.name+'  price: '+selected.price.toFixed(4)+' '+mainCurrency,8,18)
}

function updateHUD(){
  const net = netWorth()
  document.getElementById('balanceDisplay').innerText = balance.toFixed(2)+' '+mainCurrency
  document.getElementById('netWorthDisplay').innerText = net.toFixed(2)+' '+mainCurrency
  document.getElementById('profileBalance').innerText = balance.toFixed(2)+' '+mainCurrency
  document.getElementById('profileCurrency').innerText = mainCurrency
}

function netWorth(){
  let v = balance
  assets.forEach(a=> v += (a.shares || 0) * a.price )
  return v
}

// profile render
function renderProfile(){
  document.getElementById('nick').value = nickname
  document.getElementById('profileNick').value = nickname
  const tx = document.getElementById('txList'); tx.innerHTML=''
  transactions.slice().reverse().slice(0,20).forEach(t=>{ const d=document.createElement('div'); d.innerText = `${new Date(t.time).toLocaleString()}: ${t.type} ${t.qty} ${t.key} @ ${t.price.toFixed(4)} ${mainCurrency} => ${t.total.toFixed(2)} ${mainCurrency}`; tx.appendChild(d) })
  const holdings = document.getElementById('holdingsList'); holdings.innerHTML=''
  const byCat = {}
  assets.forEach(a=>{ if(a.shares && a.shares>0){ if(!byCat[a.cat]) byCat[a.cat]=[]; byCat[a.cat].push(a) } })
  for(const cat of ['stock','crypto','currency']){
    if(byCat[cat]){
      const h = document.createElement('div'); h.style.fontWeight='700'; h.innerText = cat.toUpperCase(); holdings.appendChild(h)
      byCat[cat].forEach(a=>{ const d=document.createElement('div'); d.innerText = `${a.key} ${a.name}: ${a.shares.toFixed(2)} —à—Ç. (‚âà ${(a.shares*a.price).toFixed(2)} ${mainCurrency})`; holdings.appendChild(d) })
    }
  }
  // full profile lists
  const ptx = document.getElementById('profileTxs'); ptx.innerHTML=''
  transactions.slice().reverse().forEach(t=>{ const d=document.createElement('div'); d.style.padding='6px 0'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)'; d.innerText = new Date(t.time).toLocaleString()+': '+t.type+' '+t.qty+' '+t.key+' @ '+t.price.toFixed(4)+' '+mainCurrency+' => '+t.total.toFixed(2)+' '+mainCurrency; ptx.appendChild(d) })
  const ph = document.getElementById('profileHoldings'); ph.innerHTML=''
  assets.forEach(a=>{ if(a.shares && a.shares>0){ const d=document.createElement('div'); d.style.padding='6px 0'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)'; d.innerText = `${a.key} ${a.name}: ${a.shares.toFixed(4)} —à—Ç. (‚âà ${(a.shares*a.price).toFixed(2)} ${mainCurrency})`; ph.appendChild(d) } })
}

// trading
function showTradePanel(a){
  document.getElementById('selLabel').innerText = a.key + ' ‚Äî ' + a.name
  document.getElementById('instInfo').innerText = a.name
  document.getElementById('instPrice').innerText = a.price.toFixed(4)+' '+mainCurrency
  document.getElementById('holdings').innerText = (a.shares||0).toFixed(2)
  document.getElementById('holdingValue').innerText = ((a.shares||0) * a.price).toFixed(2)
}

function recordTx(type, a, qty, price){ const t = {time:Date.now(), type, key:a.key, qty, price, total: qty*price}; transactions.push(t); if(transactions.length>500) transactions.shift(); }

function buySelected(){
  if(!selected) { alert(t('choose_asset') || '–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤'); return }
  let qty = Number(document.getElementById('tradeQty').value) || 0
  if(qty<=0){ alert('–ö–æ–ª-–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >0'); return }
  const cost = qty * selected.price
  if(cost > balance + 1e-9){ alert(t('insufficient_funds') || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤'); return }
  balance -= cost
  selected.shares = (selected.shares || 0) + qty
  recordTx('BUY', selected, qty, selected.price)
  showTradePanel(selected); refreshTable(); updateHUD(); renderProfile();
}
function sellSelected(){
  if(!selected) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤'); return }
  let qty = Number(document.getElementById('tradeQty').value) || 0
  if(qty<=0){ alert('–ö–æ–ª-–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >0'); return }
  if((selected.shares||0) < qty - 1e-9){ alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–∫—Ü–∏–π –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏'); return }
  const revenue = qty * selected.price
  balance += revenue
  selected.shares = (selected.shares || 0) - qty
  recordTx('SELL', selected, qty, selected.price)
  showTradePanel(selected); refreshTable(); updateHUD(); renderProfile();
}

// controls: start/stop loop with speed
function startSimulation(){ if(running) return; running=true; spawnParticles(); scheduleTick(); }
function pauseSimulation(){ if(!running) return; running=false; if(tickTimer) clearTimeout(tickTimer); tickTimer=null }
function stopSimulation(){ running=false; if(tickTimer) { clearTimeout(tickTimer); tickTimer=null } }
function scheduleTick(){ if(!running) return; const interval = Math.max(10, baseInterval / Math.max(0.0001,speed)); tickTimer = setTimeout(()=>{ updatePrices(); scheduleTick() }, interval) }
function setSpeed(s){ speed = s; document.getElementById('speedLabel').innerText = speed+'x'; if(running){ if(tickTimer) clearTimeout(tickTimer); scheduleTick() } }

// currency change: convert balance and asset prices
function changeMainCurrency(newCur){
  const old = mainCurrency
  if(newCur===old) return
  const ratio = exchangeRates[newCur] / exchangeRates[old]
  // scale balance and all asset prices
  balance = balance * ratio
  assets.forEach(a=>{ a.price = a.price * ratio; a.history = a.history.map(v=>v*ratio); /* baseUSD keep in USD: convert baseUSD accordingly */ a.baseUSD = a.baseUSD * ratio })
  mainCurrency = newCur
  document.getElementById('mainCurrency').value = mainCurrency
  renderNewsTicker(); refreshTable(); drawChart(); updateHUD(); renderProfile();
}

// save/load
function saveState(){
  const state = {timestamp:Date.now(), nickname, balance, level, speed, mainCurrency, transactions, assets: assets.map(a=>({key:a.key,name:a.name,baseUSD:a.baseUSD,price:a.price,history:a.history,cat:a.cat,shares:a.shares}))}
  const dataStr = 'data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(state,null,2))
  const a = document.createElement('a'); a.href=dataStr; a.download = 'Market_Game_save_'+(new Date()).toISOString().slice(0,19)+'.json'; document.body.appendChild(a); a.click(); a.remove();
}
function loadStateFromFile(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result)
      if(obj.assets){
        nickname = obj.nickname || nickname
        balance = Number(obj.balance) || balance
        applyLevel(obj.level || level)
        speed = Number(obj.speed) || speed
        mainCurrency = obj.mainCurrency || mainCurrency
        transactions = obj.transactions || transactions
        const map = {}
        obj.assets.forEach(a=> map[a.key] = a)
        assets.forEach(a=>{
          if(map[a.key]){
            a.baseUSD = Number(map[a.key].baseUSD) || a.baseUSD
            a.price = Number(map[a.key].price) || a.price
            a.history = Array.isArray(map[a.key].history) && map[a.key].history.length>0 ? map[a.key].history : a.history
            a.shares = Number(map[a.key].shares) || 0
          }
        })
        document.getElementById('mainCurrency').value = mainCurrency
        refreshTable(); spawnParticles(); drawScene(); drawChart(); updateHUD(); renderProfile();
        alert('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ')
      } else alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–∞–π–ª')
    } catch(e){ alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ —Ñ–∞–π–ª–∞: '+e) }
  }
  r.readAsText(file)
}

// UI wiring
function setupUI(){
  const startLevelEl = document.getElementById('startLevel');
  const startBalanceEl = document.getElementById('startBalance');
  const startBalanceLabel = document.getElementById('startBalanceLabel');
  startLevelEl.onchange = ()=>{ if(startLevelEl.value==='0'){ startBalanceEl.style.display='inline-block'; startBalanceLabel.style.display='inline-block' } else { startBalanceEl.style.display='none'; startBalanceLabel.style.display='none' } }

  document.getElementById('btnStart').onclick = ()=>{
    const chosen = document.getElementById('startLevel').value; const nick = document.getElementById('startNick').value; nickname = nick || nickname;
    // set language chosen before start
    const selLang = document.getElementById('startLang').value; if(selLang){ setLang(selLang); }
    applyLevel(chosen);
    const cur = document.getElementById('startCurrency').value; mainCurrency = cur; document.getElementById('mainCurrency').value = mainCurrency;
    // set balance according to level
    if(Number(chosen)===0){ balance = Number(document.getElementById('startBalance').value) || 1000 } else if(Number(chosen)===1){ balance = 3000 } else if(Number(chosen)===2){ balance = 1000 } else { balance = 500 }
    // Convert assets initial pricing to selected currency
    assets.forEach(a=>{ a.price = a.baseUSD * exchangeRates[mainCurrency]; a.history = [a.price] })
    document.getElementById('startOverlay').style.display='none'; startSimulation(); updateHUD(); renderProfile();
  }
  document.getElementById('mainStart').onclick = ()=>{ startSimulation() }
  document.getElementById('mainPause').onclick = ()=>{ if(running) pauseSimulation(); else startSimulation() }
  document.getElementById('btnSave').onclick = ()=>{ saveState(); alert(t('save') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ (JSON)') }
  document.getElementById('mainSave').onclick = ()=>{ saveState(); alert(t('save') || '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ (JSON)') }
  document.getElementById('btnExit').onclick = ()=>{ if(confirm(t('exit') || '–í—ã–π—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?')) location.reload() }
  document.getElementById('mainExit').onclick = ()=>{ if(confirm(t('exit') || '–í—ã–π—Ç–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?')) location.reload() }
  document.getElementById('btnLoad').onclick = ()=> fileIn.click()
  fileIn.onchange = (e)=>{ if(e.target.files && e.target.files[0]) loadStateFromFile(e.target.files[0]); fileIn.value = '' }
  document.getElementById('btnBuy').onclick = buySelected
  document.getElementById('btnSell').onclick = sellSelected
  document.getElementById('applyLevel').onclick = ()=>{ const v = document.getElementById('levelSelect').value; applyLevel(v); alert(t('apply')+': '+document.getElementById('levelLabel').innerText) }
  document.getElementById('nick').onchange = ()=>{ nickname = document.getElementById('nick').value }
  document.getElementById('profileNick').onchange = ()=>{ nickname = document.getElementById('profileNick').value; document.getElementById('nick').value = nickname }
  // speed buttons
  const wrap = document.getElementById('speedBtns'); speedOptions.forEach(s=>{ const b=document.createElement('button'); b.innerText = s; b.title = s+'x'; b.onclick = ()=>{ setSpeed(s); document.querySelectorAll('.speedBtns button').forEach(x=>x.classList.remove('active')); b.classList.add('active') }; if(s===1) b.classList.add('active'); wrap.appendChild(b) })
  // tabs
  document.querySelectorAll('.tab').forEach(t=>{ t.onclick = ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); currentFilter = t.dataset.filter; refreshTable() } })
  // currency selector
  document.getElementById('mainCurrency').onchange = (e)=>{ changeMainCurrency(e.target.value) }
  // news ticker click
  document.getElementById('newsTicker').onclick = ()=>{ renderNewsModal(); document.getElementById('newsModal').style.display='flex' }
  document.getElementById('closeNews').onclick = ()=>{ document.getElementById('newsModal').style.display='none' }
  // profile view open/close
  document.getElementById('openProfileBtn').onclick = ()=>{ document.getElementById('profileView').style.display='block'; renderProfile(); }
  document.getElementById('openGameBtn').onclick = ()=>{ document.getElementById('profileView').style.display='none' }
  document.getElementById('closeProfile').onclick = ()=>{ document.getElementById('profileView').style.display='none' }
}

// init
initAssets(); setupUI(); refreshTable(); spawnParticles(); drawScene(); updateHUD(); renderProfile();
setTimeout(()=>{ const first = document.querySelector('#assetsTable tbody tr'); if(first) first.click() },300)
</script>

<script>
// language modal behavior (wiring)
const langBtn = document.getElementById('langBtn');
const langModal = document.getElementById('langModal');
const langClose = document.getElementById('langClose');
const langScroll = document.getElementById('langScroll');
const langRange = document.getElementById('langRange');
const currentLangSpan = document.getElementById('currentLang');
if(langBtn){
  langBtn.addEventListener('click', ()=>{ langModal.style.display = (langModal.style.display==='flex'?'none':'flex'); langModal.style.flexDirection='column'; });
}
if(langClose){ langClose.addEventListener('click', ()=>{ langModal.style.display='none'; }); }
// language items
document.querySelectorAll('.langItem').forEach(b=>{ b.addEventListener('click', ()=>{ const l=b.getAttribute('data-lang'); setLang(l); currentLangSpan.innerText = l.toUpperCase(); langModal.style.display='none'; }); });
// slider scroll sync
if(langRange){ langRange.addEventListener('input', e=>{ const pct = e.target.value/100; const max = langScroll.scrollWidth - langScroll.clientWidth; langScroll.scrollLeft = Math.round(max*pct); }); langScroll.addEventListener('scroll', ()=>{ const max = langScroll.scrollWidth - langScroll.clientWidth; const pct = max? Math.round((langScroll.scrollLeft/max)*100):0; langRange.value = pct; }); }

// initialize UI language indicators
updateUiLangIndicators(); applyTranslations();
</script>

</body>
</html>
